{% extends 'base.html' %}

{% block title %}Chat with {{ stakeholder.name }}{% endblock %}

{% block extra_css %}
<style>
    #chat-messages {
        height: 500px;
        overflow-y: auto;
        border: 1px solid #dee2e6;
        padding: 15px;
        background-color: #f8f9fa;
    }
    .message {
        margin-bottom: 15px;
        padding: 10px;
        border-radius: 10px;
    }
    .message.user {
        background-color: #007bff;
        color: white;
        margin-left: 20%;
    }
    .message.stakeholder {
        background-color: #e9ecef;
        color: #333;
        margin-right: 20%;
    }
    .message-header {
        font-weight: bold;
        margin-bottom: 5px;
    }
    .message-time {
        font-size: 0.8em;
        opacity: 0.7;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">
                    <span style="font-size: 1.5em;">{{ stakeholder.avatar|default:"ðŸ‘¤" }}</span>
                    Chat with {{ stakeholder.name }}
                    <span class="badge bg-success ms-2">Online</span>
                </h4>
            </div>
            <div class="card-body">
                <div id="chat-messages">
                    {% for message in messages %}
                        <div class="message {% if message.is_from_stakeholder %}stakeholder{% else %}user{% endif %}">
                            <div class="message-header">
                                {% if message.is_from_stakeholder %}
                                    {{ stakeholder.name }}
                                {% else %}
                                    You
                                {% endif %}
                            </div>
                            <div class="message-content">{{ message.content }}</div>
                            <div class="message-time">{{ message.created_at|date:"H:i" }}</div>
                        </div>
                    {% empty %}
                        <p class="text-center text-muted">No messages yet. Start the conversation!</p>
                    {% endfor %}
                </div>
                <div class="mt-3">
                    <form id="message-form">
                        {% csrf_token %}
                        <div class="input-group">
                            <input type="text" class="form-control" id="message-input" placeholder="Type your message...">
                            <button class="btn btn-primary" type="submit">
                                <i class="bi bi-send"></i> Send
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const stakeholderId = {{ stakeholder.id }};
    const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = wsProtocol + '//' + window.location.host + '/ws/chat/' + stakeholderId + '/';
    
    console.log('Attempting WebSocket connection to:', wsUrl);
    
    const chatSocket = new WebSocket(wsUrl);

    chatSocket.onopen = function(e) {
        console.log('WebSocket connection opened successfully');
    };

    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const messagesDiv = document.getElementById('chat-messages');
        
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message ' + (data.type === 'stakeholder_message' ? 'stakeholder' : 'user');
        
        const header = document.createElement('div');
        header.className = 'message-header';
        header.textContent = data.type === 'stakeholder_message' ? data.stakeholder : 'You';
        
        const content = document.createElement('div');
        content.className = 'message-content';
        content.textContent = data.message;
        
        const time = document.createElement('div');
        time.className = 'message-time';
        const date = new Date(data.timestamp);
        time.textContent = date.toLocaleTimeString();
        
        messageDiv.appendChild(header);
        messageDiv.appendChild(content);
        messageDiv.appendChild(time);
        
        messagesDiv.appendChild(messageDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    };

    chatSocket.onerror = function(error) {
        console.error('WebSocket error details:');
        console.error('  Error object:', error);
        console.error('  WebSocket URL:', wsUrl);
        console.error('  WebSocket readyState:', chatSocket.readyState);
        console.error('  WebSocket protocol:', chatSocket.protocol);
        console.error('  WebSocket extensions:', chatSocket.extensions);
        
        // Show user-friendly error
        const messagesDiv = document.getElementById('chat-messages');
        const errorDiv = document.createElement('div');
        errorDiv.className = 'alert alert-danger';
        errorDiv.innerHTML = '<strong>Connection Error:</strong> Unable to connect to chat server. Please refresh the page and try again.';
        messagesDiv.appendChild(errorDiv);
    };

    chatSocket.onclose = function(e) {
        console.error('Chat socket closed. Code:', e.code, 'Reason:', e.reason, 'WasClean:', e.wasClean);
        if (e.code === 4001) {
            alert('Authentication failed. Please log in again.');
        } else if (e.code !== 1000) {
            console.error('Unexpected WebSocket closure');
        }
    };

    document.querySelector('#message-form').onsubmit = function(e) {
        e.preventDefault();
        const messageInputDom = document.querySelector('#message-input');
        const message = messageInputDom.value;
        
        if (message) {
            chatSocket.send(JSON.stringify({
                'message': message
            }));
            messageInputDom.value = '';
        }
    };
</script>
{% endblock %}

